<!DOCTYPE html>
<html lang="en" data-theme="light">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Products | Lumina Admin</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/admin.css">
</head>

<body class="admin-body">

    <div class="admin-layout">
        <aside class="admin-sidebar">
            <div class="admin-logo">
                <i class="fas fa-layer-group text-primary"></i> Lumina Admin
            </div>
            <nav class="admin-nav">
                <a href="index.html"><i class="fas fa-chart-pie"></i> Dashboard</a>
                <a href="products.html" class="active"><i class="fas fa-box"></i> Products</a>
                <a href="orders.html"><i class="fas fa-shopping-cart"></i> Orders</a>
            </nav>
            <div class="admin-logout">
                <button id="admin-logout-btn"><i class="fas fa-sign-out-alt"></i> Logout</button>
            </div>
        </aside>

        <main class="admin-main">
            <header class="admin-header">
                <h2 style="font-size: 1.3rem;">Products Management</h2>
                <div style="display: flex; align-items:center; gap:15px;">
                    <button id="theme-toggle"
                        style="background:transparent; cursor:pointer; color:var(--text-primary); font-size:1.2rem;">
                        <i class="fas fa-moon"></i>
                    </button>
                    <div style="display:flex; align-items:center; gap:10px;">
                        <span id="admin-name" style="font-weight:600;">Admin</span>
                    </div>
                </div>
            </header>

            <div class="admin-content">
                <div class="admin-panel">
                    <div class="admin-panel-header">
                        <h3 style="font-size: 1.2rem;">All Products</h3>
                        <button class="btn btn-primary" onclick="openProductModal()"><i class="fas fa-plus"></i> Add
                            Product</button>
                    </div>
                    <div class="admin-table-wrapper">
                        <table class="admin-table">
                            <thead>
                                <tr>
                                    <th>Image</th>
                                    <th>Name</th>
                                    <th>Category</th>
                                    <th>Price</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="products-table">
                                <!-- Injected via JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Product Modal overlay -->
    <div class="modal-overlay" id="product-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-title">Add New Product</h3>
                <button class="modal-close" onclick="closeModal('product-modal')"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <form id="product-form">
                    <input type="hidden" id="p-id">
                    <div class="form-group" style="margin-bottom: 15px;">
                        <label class="form-label">Product Name</label>
                        <input type="text" class="form-control" id="p-name" required>
                    </div>
                    <div class="form-group" style="margin-bottom: 15px;">
                        <label class="form-label">Category</label>
                        <select class="form-control" id="p-category" required>
                            <option value="Electronics">Electronics</option>
                            <option value="Fashion">Fashion</option>
                            <option value="Accessories">Accessories</option>
                        </select>
                    </div>
                    <div class="form-group" style="margin-bottom: 15px;">
                        <label class="form-label">Price ($)</label>
                        <input type="number" class="form-control" id="p-price" step="0.01" required>
                    </div>
                    <div class="form-group" style="margin-bottom: 15px;">
                        <label class="form-label">Image URL</label>
                        <input type="url" class="form-control" id="p-image" required placeholder="https://...">
                    </div>
                    <div class="form-group" style="margin-bottom: 15px;">
                        <label class="form-label">Details</label>
                        <textarea class="form-control" id="p-details" rows="3" required></textarea>
                    </div>

                    <div style="display: flex; gap: 10px; margin-top: 25px;">
                        <button type="submit" class="btn btn-primary" style="flex: 1;">Save Product</button>
                        <button type="button" class="btn btn-outline" style="flex: 1;"
                            onclick="closeModal('product-modal')">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Core Scripts -->
    <script src="../js/data.js"></script>
    <script src="../js/app.js"></script>
    <script src="../js/admin.js"></script>
    <script>
        let products = [];

        document.addEventListener('DOMContentLoaded', () => {
            // auth check handled in admin.js
            if (JSON.parse(localStorage.getItem('ecommerce_currentUser') || "null")?.role !== 'admin') return;

            loadProducts();

            // Setup Form 
            document.getElementById('product-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const idVal = document.getElementById('p-id').value;
                const name = document.getElementById('p-name').value;
                const category = document.getElementById('p-category').value;
                const price = parseFloat(document.getElementById('p-price').value);
                const image = document.getElementById('p-image').value;
                const details = document.getElementById('p-details').value;

                if (idVal) {
                    // Edit Mode
                    const prodIndex = products.findIndex(p => p.id == idVal);
                    if (prodIndex > -1) {
                        products[prodIndex] = { ...products[prodIndex], name, category, price, image, details };
                    }
                } else {
                    // Add Mode
                    const newId = products.length > 0 ? Math.max(...products.map(p => p.id)) + 1 : 1;
                    products.push({ id: newId, name, category, price, image, details, rating: 5.0, reviews: 0 });
                }

                localStorage.setItem('ecommerce_products', JSON.stringify(products));
                closeModal('product-modal');
                loadProducts();

                // show simplistic toast
                alert('Product Saved successfully.');
            });
        });

        function loadProducts() {
            products = JSON.parse(localStorage.getItem('ecommerce_products') || "[]");
            const tbody = document.getElementById('products-table');

            if (products.length === 0) {
                tbody.innerHTML = `<tr><td colspan="5" style="text-align:center;">No Products Found</td></tr>`;
                return;
            }

            tbody.innerHTML = products.map(p => `
                <tr>
                    <td><img src="${p.image}" style="width: 50px; height: 50px; object-fit: cover; border-radius: 5px;"></td>
                    <td style="font-weight:500;">${p.name}</td>
                    <td><span style="background:var(--bg-main); padding:4px 8px; border-radius:5px; font-size:0.8rem;">${p.category}</span></td>
                    <td style="font-weight:700; color:var(--primary);">${formatPrice(p.price)}</td>
                    <td>
                        <button class="admin-action-btn" onclick="editProduct(${p.id})"><i class="fas fa-edit"></i></button>
                        <button class="admin-action-btn delete" onclick="deleteProduct(${p.id})"><i class="fas fa-trash-alt"></i></button>
                    </td>
                </tr>
            `).join('');
        }

        window.openProductModal = function () {
            document.getElementById('product-form').reset();
            document.getElementById('p-id').value = '';
            document.getElementById('modal-title').textContent = 'Add New Product';
            openModal('product-modal');
        }

        window.editProduct = function (id) {
            const p = products.find(x => x.id === id);
            if (p) {
                document.getElementById('p-id').value = p.id;
                document.getElementById('p-name').value = p.name;
                document.getElementById('p-category').value = p.category;
                document.getElementById('p-price').value = p.price;
                document.getElementById('p-image').value = p.image;
                document.getElementById('p-details').value = p.details;

                document.getElementById('modal-title').textContent = 'Edit Product';
                openModal('product-modal');
            }
        }

        window.deleteProduct = function (id) {
            if (confirm('Are you sure you want to delete this product?')) {
                products = products.filter(x => x.id !== id);
                localStorage.setItem('ecommerce_products', JSON.stringify(products));
                loadProducts();
            }
        }
    </script>
</body>

</html>