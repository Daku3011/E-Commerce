<!DOCTYPE html>
<html lang="en" data-theme="light">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Orders | Lumina Admin</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/admin.css">
</head>

<body class="admin-body">

    <div class="admin-layout">
        <aside class="admin-sidebar">
            <div class="admin-logo">
                <i class="fas fa-layer-group text-primary"></i> Lumina Admin
            </div>
            <nav class="admin-nav">
                <a href="index.html"><i class="fas fa-chart-pie"></i> Dashboard</a>
                <a href="products.html"><i class="fas fa-box"></i> Products</a>
                <a href="orders.html" class="active"><i class="fas fa-shopping-cart"></i> Orders</a>
            </nav>
            <div class="admin-logout">
                <button id="admin-logout-btn"><i class="fas fa-sign-out-alt"></i> Logout</button>
            </div>
        </aside>

        <main class="admin-main">
            <header class="admin-header">
                <h2 style="font-size: 1.3rem;">Orders Management</h2>
                <div style="display: flex; align-items:center; gap:15px;">
                    <button id="theme-toggle"
                        style="background:transparent; cursor:pointer; color:var(--text-primary); font-size:1.2rem;">
                        <i class="fas fa-moon"></i>
                    </button>
                    <div style="display:flex; align-items:center; gap:10px;">
                        <span id="admin-name" style="font-weight:600;">Admin</span>
                    </div>
                </div>
            </header>

            <div class="admin-content">
                <div class="admin-panel">
                    <div class="admin-panel-header">
                        <h3 style="font-size: 1.2rem;">All Orders</h3>
                    </div>
                    <div class="admin-table-wrapper">
                        <table class="admin-table">
                            <thead>
                                <tr>
                                    <th>Order ID</th>
                                    <th>Date</th>
                                    <th>Customer (User ID)</th>
                                    <th>Total</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="orders-table">
                                <!-- Injected -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Order Details Modal -->
    <div class="modal-overlay" id="order-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Order Status Update</h3>
                <button class="modal-close" onclick="closeModal('order-modal')"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body" style="text-align: center;">
                <p style="margin-bottom: 20px;">Current Status: <strong id="modal-order-status">Pending</strong></p>

                <input type="hidden" id="modal-order-id">

                <select id="new-status" class="form-control" style="margin-bottom: 20px;">
                    <option value="Pending">Pending</option>
                    <option value="Shipped">Shipped</option>
                    <option value="Delivered">Delivered</option>
                </select>

                <button class="btn btn-primary" onclick="updateOrderStatus()">Save Update</button>
            </div>
        </div>
    </div>

    <!-- Core Scripts -->
    <script src="../js/data.js"></script>
    <script src="../js/app.js"></script>
    <script src="../js/admin.js"></script>
    <script>
        let orders = [];

        document.addEventListener('DOMContentLoaded', () => {
            if (JSON.parse(localStorage.getItem('ecommerce_currentUser') || "null")?.role !== 'admin') return;
            loadOrders();
        });

        function loadOrders() {
            orders = JSON.parse(localStorage.getItem('ecommerce_orders') || "[]");
            // sort recent first
            orders.sort((a, b) => new Date(b.date) - new Date(a.date));

            const tbody = document.getElementById('orders-table');

            if (orders.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6" style="text-align:center;">No Orders Found</td></tr>`;
                return;
            }

            tbody.innerHTML = orders.map(o => {
                const date = new Date(o.date).toLocaleDateString();
                const userIdDisp = typeof o.userId === 'string' ? o.userId.substring(0, 8) + '...' : o.userId;
                return `
                <tr>
                    <td style="font-weight:600;">#${o.orderId}</td>
                    <td>${date}</td>
                    <td style="color:var(--text-secondary);">${userIdDisp}</td>
                    <td style="font-weight:700; color:var(--primary);">${formatPrice(o.total)}</td>
                    <td>
                        <span class="badge-status status-${o.status}" style="padding:4px 10px; border-radius:15px; font-size:0.8rem;">
                            ${o.status}
                        </span>
                    </td>
                    <td>
                        <button class="admin-action-btn" onclick="openStatusModal('${o.orderId}')" aria-label="Update Status" title="Update Status">
                            <i class="fas fa-wrench"></i>
                        </button>
                    </td>
                </tr>
                `;
            }).join('');
        }

        window.openStatusModal = function (orderId) {
            const order = orders.find(x => x.orderId === orderId);
            if (order) {
                document.getElementById('modal-order-id').value = order.orderId;
                document.getElementById('modal-order-status').textContent = order.status;
                document.getElementById('new-status').value = order.status;
                openModal('order-modal');
            }
        }

        window.updateOrderStatus = function () {
            const orderId = document.getElementById('modal-order-id').value;
            const newStatus = document.getElementById('new-status').value;

            const index = orders.findIndex(x => x.orderId === orderId);
            if (index > -1) {
                orders[index].status = newStatus;
                localStorage.setItem('ecommerce_orders', JSON.stringify(orders));
                closeModal('order-modal');
                loadOrders();
                alert('Order Status Updated Successfully.');
            }
        }
    </script>
</body>

</html>